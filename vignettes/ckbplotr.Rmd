---
title: "Get started with ckbplotr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started with ckbplotr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 7,
  fig.align = "center"
)
```

```{r setup, include = F}
library(ckbplotr)
```
## Shape plots
`make_shape_plot()` creates a plot of estimates and CIs against risk factor levels using the `ggplot2` package. The function returns both a plot and the ggplot2 code used to create the plot. In RStudio the ggplot2 code used to create the plot will be shown in the  Viewer pane (with syntax highlighting if the [highlights](https://cran.r-project.org/package=highlight) package is installed).

The function uses `plot_like_ckb()` to modify the theme and control the look of the plot.

### Example data
```{r prep data, include = FALSE}
results <- data.frame(
  est       = c(   1, 1.25,  1.5, 1.75,  1.7, 1.85, 2.25, 2.6),
  se        = c(0.08, 0.03, 0.07, 0.15, 0.08, 0.08, 0.07, 0.1),
  rf        = c(  20,   28,   38,   50, 18.5,   25,   37,  47),
  n         = c( 109,  103,  143,  104,  140,  134,  127,  99),
  is_female = c(   0,    0,    0,    0,    1,    1,    1,   1)
)
```

```{r}
results
```

### Simple example
Given a data frame of estimates and standard errors (to be plotted on the y axis),
and risk factor levels (to be plotted on the x axis), a plot can be created.
```{r simple-example, fig.height = 4, fig.width = 4, out.width = "50%"}
plot <- make_shape_plot(results[results$is_female == 0,],
                        col.x        = "rf",
                        col.estimate = "est",
                        col.stderr   = "se",
                        col.n        = "n",
                        xlims        = c(15, 50),
                        ylims        = c(0.5, 3),
                        scalepoints  = TRUE,
                        title        = NULL)
```

For more details on customising these forest plots, see ["More with shape plots"](make_shape_plot.html).

## Forest plots
`make_forest_plot()` creates a forest plot using the [ggplot2](https://ggplot2.tidyverse.org/) graphics package. The function returns both a plot and the ggplot2 code used to create the plot. In RStudio the code used to create the plot will be shown in the Viewer pane (with syntax highlighting if the [highlights](https://cran.r-project.org/package=highlight) package is installed).

### Prepare data
First of all, do your analyses and put the results into data frames (one data frame for each forest plot panel). Here is part of some example results:
```{r example forest plot results, echo = FALSE}
set.seed(57911624)
exampleresults <- function(){
  data.frame(variable = c('nmr_l_vldl_p', 'nmr_m_vldl_p', 'nmr_s_vldl_p',
                          'nmr_idl_p',
                          'nmr_l_ldl_p', 'nmr_m_ldl_p', 'nmr_s_ldl_p',
                          'nmr_l_vldl_tg', 'nmr_m_vldl_tg', 'nmr_s_vldl_tg',
                          'nmr_idl_tg',
                          'nmr_l_ldl_tg', 'nmr_m_ldl_tg', 'nmr_s_ldl_tg',
                          'nmr_l_vldl_c', 'nmr_m_vldl_c', 'nmr_s_vldl_c',
                          'nmr_idl_c',
                          'nmr_l_ldl_c', 'nmr_m_ldl_c', 'nmr_s_ldl_c'),
             estimate = rnorm(21, 0, 0.02),
             stderr   = 0.012 + abs(rnorm(21, 0, 0.015)),
             n        = round(runif(21, 100, 2000)),
             nb       = round(runif(21, 100, 2000)),
             shape    = rep(15, 21),
             colour   = "black",
             fill     = "black",
             bold     = FALSE,
             diamond  = FALSE,
             ciunder  = FALSE,
             stringsAsFactors = FALSE)
}
resultsA <- exampleresults()
resultsB <- exampleresults()
resultsC <- exampleresults()
resultsD <- exampleresults()
resultsE <- exampleresults()

head(resultsA[,c("variable", "estimate", "stderr", "n")])
```


### Simple forest plot
```{r simple-forest-plot, fig.height = 5, out.width = "90%"}
forestplot <- make_forest_plot(panels         = list(resultsA, resultsB),
                               col.key        = "variable",
                               exponentiate   = TRUE)
```

### Using row labels
To use row labels, first create a data frame of labels. The data set must contain:

* a column used to match labels to the correct results, specified in the argument `col.key`.
* up to three columns with headings/subheadings/labels for rows.

If a particular level of label is not required it can be set to missing.

```{r forest plot headings, eval=TRUE, echo=FALSE}
# Example label for every row
# This could be loaded from a csv containing labels that you use often
mylabels <- data.frame(heading = rep(c("Lipoprotein particle concentration",
                                        "Triglycerides concentration",
                                        "Cholesterol concentration"), each = 7),
                       subheading = rep(c("VLDL", "VLDL", "VLDL",
                                        "IDL",
                                        "LDL", "LDL", "LDL"), times = 3),
                       label = rep(c("Large", "Medium", "Small",
                                        NA,
                                        "Large", "Medium", "Small") , times = 3),
                       variable = c('nmr_l_vldl_p', 'nmr_m_vldl_p', 'nmr_s_vldl_p',
                                    'nmr_idl_p',
                                    'nmr_l_ldl_p', 'nmr_m_ldl_p', 'nmr_s_ldl_p',
                                    'nmr_l_vldl_tg', 'nmr_m_vldl_tg', 'nmr_s_vldl_tg',
                                    'nmr_idl_tg',
                                    'nmr_l_ldl_tg', 'nmr_m_ldl_tg', 'nmr_s_ldl_tg',
                                    'nmr_l_vldl_c', 'nmr_m_vldl_c', 'nmr_s_vldl_c',
                                    'nmr_idl_c',
                                    'nmr_l_ldl_c', 'nmr_m_ldl_c', 'nmr_s_ldl_c'),
                       stringsAsFactors = FALSE)
```
```{r mylabels}
head(mylabels)
```

In `make_forest_plot()` specify the `row.labels` argument as the data frame of labels you've created. Use the `row.labels.levels` argument to choose which columns are used as headings/subheadings/labels.

Use the `rows` argument to choose the results to be plotted. The function will plot results whose heading1 label is in the `rows` argument. The order given in the `rows` argument decides the order in which the heading1 labels will be in the plot (top to bottom). The heading2 and heading3 labels will be in the order that they are in the `row.labels` data frame.

```{r using-row-labels, fig.height = 5, out.width = "90%"}
forestplot <- make_forest_plot(panels            = list(resultsA, resultsB),
                               col.key           = "variable",
                               row.labels        = mylabels,
                               row.labels.levels = c("heading", "subheading", "label"),
                               rows              = c("Triglycerides concentration",
                                                     "Lipoprotein particle concentration"),
                               exponentiate      = TRUE,
                               panel.headings    = c("Analysis A", "Analysis B"),
                               xlim              = c(0.9, 1.1),
                               xticks            = c(0.9, 1, 1.1),
                               scalepoints       = TRUE,
                               pointsize         = 3)
```

In this plot we've also use the `panel.headings`, `xlim`, `xticks`, `scalepoints`, and `pointsize` arguments to customise the plot.

For more details on customising these forest plots, see ["More with forest plots"](make_forest_plot.html).



## Other plots
Supply an existing [ggplot2](https://ggplot2.tidyverse.org/) plot as the `plot` argument to `plot_like_ckb()`:
```{r a-plot, fig.height = 4, fig.width=8, out.width = "80%"}
plot <- ggplot(data = mpg,
               aes(x = displ, y = hwy)) +
  geom_point(size = 1)

ckbplot <- plot_like_ckb(plot = plot,
                         xlims = c(0, 8),
                         ylims = c(10, 50))

gridExtra::grid.arrange(plot, ckbplot, ncol = 2)
```

See ["Make any ggplot like a CKB plot"](plot_like_ckb.html) for more details.
