---
title: "Changing narrow forest plot confidence interval lines"
output:
  rmarkdown::html_vignette:
    fig_width: 7
    fig_height: 7
    toc: TRUE
vignette: >
  %\VignetteIndexEntry{Changing narrow forest plot confidence interval lines}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 10,
  fig.align = "center"
)
```

```{r setup, include = FALSE}
library(ckbplotr)

set.seed(57911624)
exampleresults <- function(){
  data.frame(variable = c('nmr_l_vldl_p', 'nmr_m_vldl_p', 'nmr_s_vldl_p',
                          'nmr_idl_p',
                          'nmr_l_ldl_p', 'nmr_m_ldl_p', 'nmr_s_ldl_p',
                          'nmr_l_vldl_tg', 'nmr_m_vldl_tg', 'nmr_s_vldl_tg',
                          'nmr_idl_tg',
                          'nmr_l_ldl_tg', 'nmr_m_ldl_tg', 'nmr_s_ldl_tg',
                          'nmr_l_vldl_c', 'nmr_m_vldl_c', 'nmr_s_vldl_c',
                          'nmr_idl_c',
                          'nmr_l_ldl_c', 'nmr_m_ldl_c', 'nmr_s_ldl_c'),
             estimate = rnorm(21, 0, 0.02),
             stderr   = 0.012 + abs(rnorm(21, 0, 0.015)),
             n        = round(runif(21, 100, 2000)),
             nb       = round(runif(21, 100, 2000)),
             shape    = rep(15, 21),
             colour   = "black",
             fill     = "black",
             bold     = FALSE,
             diamond  = FALSE,
             ciunder  = FALSE,
             stringsAsFactors = FALSE)
}
resultsA <- exampleresults()
resultsB <- exampleresults()
resultsC <- exampleresults()
resultsD <- exampleresults()
resultsE <- exampleresults()

resultsA[9,"shape"] <- 16
resultsA[10, "bold"] <- TRUE
resultsA[11, "colour"] <- "red"
resultsA[12, "diamond"] <- TRUE
resultsA[13, "ciunder"] <- TRUE
resultsA[13, "shape"] <- 22
resultsA[13, "fill"] <- "white"

mylabels <- data.frame(heading1 = rep(c("Lipoprotein particle concentration",
                                        "Triglycerides concentration",
                                        "Cholesterol concentration"), each = 7),
                       heading2 = rep(c("VLDL", "VLDL", "VLDL",
                                        "IDL",
                                        "LDL", "LDL", "LDL"), times = 3),
                       heading3 = rep(c("Large", "Medium", "Small",
                                        NA,
                                        "Large", "Medium", "Small") , times = 3),
                       variable = c('nmr_l_vldl_p', 'nmr_m_vldl_p', 'nmr_s_vldl_p',
                                    'nmr_idl_p',
                                    'nmr_l_ldl_p', 'nmr_m_ldl_p', 'nmr_s_ldl_p',
                                    'nmr_l_vldl_tg', 'nmr_m_vldl_tg', 'nmr_s_vldl_tg',
                                    'nmr_idl_tg',
                                    'nmr_l_ldl_tg', 'nmr_m_ldl_tg', 'nmr_s_ldl_tg',
                                    'nmr_l_vldl_c', 'nmr_m_vldl_c', 'nmr_s_vldl_c',
                                    'nmr_idl_c',
                                    'nmr_l_ldl_c', 'nmr_m_ldl_c', 'nmr_s_ldl_c'),
                       stringsAsFactors = FALSE)
```

When making a forest plot, if a confidence interval line is narrower than the point representing the estimate we may wish to plot the line differently. In this package, this is possible by using the `panel.width` argument in the `make_forest_plot()` function, then using the `fix_panel_width()` function.


# Changing the colour
To plot narrow confidence widths a different colour, set the `panel.width` argument of `make_forest_plot()` equal to the width (in mm) each  panel will be in the final drawn output. The `cicolour` argument should also be a character vector - the last element will be used for narrow confidence intervals.

Then use the `fix_panel_width()` function, where the first argument is the plot just created and the second is the same panel width. This function returns a gtable object, which can be plotted using `grid::grid.draw` (or `plot()`). The panels widths will be fixed.

Notes: This has been designed to work well for shape 15 (the default) and 22. Use a small value for stroke (< 0.5) to avoid a wide border which is not accounted for. The calculation of sizes may not be entirely accurate, so check the plot and change the `plot.width` argument as needed. Confidence intervals are assumed to be centred on the point estimate.

```{r forest-plot}
forestplot <- make_forest_plot(panels            = list(resultsA, resultsB),
                               col.key           = "variable",
                               row.labels        = mylabels,
                               rows              = c("Lipoprotein particle concentration"),
                               exponentiate      = TRUE,
                               panel.names       = c("Analysis A", "Analysis B"),
                               ci.delim          = " - ",
                               xlim              = c(0.9, 1.1),
                               xticks            = c(0.9, 1, 1.1),
                               blankrows         = c(1, 1, 0, 1),
                               scalepoints       = TRUE,
                               pointsize         = 16,
                               col.left          = c("n"),
                               col.left.space    = c(0.02),
                               col.left.heading  = c("No. of\nevents"),
                               col.right.space   = 0.02,
                               col.heading.space = 0,
                               label.space       = 2,
                               panel.space       = 8,

                               # set panel width + CI colours
                               panel.width       = 25,
                               cicolour          = c("black", "white"),
                               printplot         = FALSE)

plot <- fix_panel_width(forestplot$plot, 25)
grid::grid.draw(plot)
```

The `cicolour` argument can be a vector of all names of colours, or all names of columns (which contain colour names).
```{r forest-plot-2}

resultsA$cicol1 <- "red"
resultsB$cicol1 <- "blue"
resultsA$cicol2 <- "white"
resultsB$cicol2 <- "white"

forestplot <- make_forest_plot(panels            = list(resultsA, resultsB),
                               col.key           = "variable",
                               row.labels        = mylabels,
                               rows              = c("Lipoprotein particle concentration"),
                               exponentiate      = TRUE,
                               panel.names       = c("Analysis A", "Analysis B"),
                               ci.delim          = " - ",
                               xlim              = c(0.9, 1.1),
                               xticks            = c(0.9, 1, 1.1),
                               blankrows         = c(1, 1, 0, 1),
                               scalepoints       = TRUE,
                               pointsize         = 16,
                               col.left          = c("n"),
                               col.left.space    = c(0.02),
                               col.left.heading  = c("No. of\nevents"),
                               col.right.space   = 0.02,
                               col.heading.space = 0,
                               label.space       = 2,
                               panel.space       = 8,

                               # set panel width + CI colours
                               panel.width       = 25,
                               cicolour          = c("cicol1", "cicol2"),
                               printplot         = FALSE)

plot <- fix_panel_width(forestplot$plot, 25)
grid::grid.draw(plot)
```


# Plotting lines under or over points
As well as changing colour, we may also wish to change if confidence interval lines are plotted under or over the point estimates. This can be done using the `plot.width` argument and using a logical (or character) vector for the `ciunder` argument.

```{r forest-plot-3}
forestplot <- make_forest_plot(panels            = list(resultsA, resultsB),
                               col.key           = "variable",
                               row.labels        = mylabels,
                               rows              = c("Lipoprotein particle concentration"),
                               exponentiate      = TRUE,
                               panel.names       = c("Analysis A", "Analysis B"),
                               ci.delim          = " - ",
                               xlim              = c(0.9, 1.1),
                               xticks            = c(0.9, 1, 1.1),
                               blankrows         = c(1, 1, 0, 1),
                               scalepoints       = TRUE,
                               pointsize         = 18,
                               col.left          = c("n"),
                               col.left.space    = c(0.02),
                               col.left.heading  = c("No. of\nevents"),
                               col.right.space   = 0.02,
                               col.heading.space = 0,
                               label.space       = 2,
                               panel.space       = 8,

                               # set panel width + CI under or over
                               panel.width       = 25,
                               shape             = 22,
                               stroke            = 0.5,
                               fill              = "white",
                               ciunder           = c(TRUE, FALSE),
                               printplot         = FALSE)

plot <- fix_panel_width(forestplot$plot, 25)
grid::grid.draw(plot)
```

# Changing colour and plotting of lines

```{r forest-plot-4}
resultsA <- dplyr::select(resultsA, -ciunder)
resultsA$cicol1 <- "black"
resultsA$cicol2 <- "white"
resultsA$shape <- 15

resultsB <- dplyr::select(resultsB, -ciunder)
resultsB$cicol1 <- "black"
resultsB$cicol2 <- "black"
resultsB$shape <- 22

forestplot <- make_forest_plot(panels            = list(resultsA, resultsB),
                               col.key           = "variable",
                               row.labels        = mylabels,
                               rows              = c("Lipoprotein particle concentration"),
                               exponentiate      = TRUE,
                               panel.names       = c("Analysis A", "Analysis B"),
                               ci.delim          = " - ",
                               xlim              = c(0.9, 1.1),
                               xticks            = c(0.9, 1, 1.1),
                               blankrows         = c(1, 1, 0, 1),
                               scalepoints       = TRUE,
                               pointsize         = 18,
                               col.left          = c("n"),
                               col.left.space    = c(0.02),
                               col.left.heading  = c("No. of\nevents"),
                               col.right.space   = 0.02,
                               col.heading.space = 0,
                               label.space       = 2,
                               panel.space       = 8,

                               # set panel width + CI colours
                               panel.width       = 25,
                               shape             = "shape",
                               stroke            = 0.5,
                               cicolour          = c("cicol1", "cicol2"),
                               ciunder           = c(TRUE, FALSE),
                               fill              = "white",
                               printplot         = FALSE)

plot <- fix_panel_width(forestplot$plot, 25)
grid::grid.draw(plot)
```

