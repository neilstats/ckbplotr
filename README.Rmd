---
output:
  github_document:
    html_preview: false
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  fig.width = 4,
  fig.height = 4,
  fig.align = "center")
library(ckbplotr)
```
# ckbplotr

`ckbplotr` provides functions to help create and style plots in R. It is being
developed by, and primarily for, [China Kadoorie Biobank](http://www.ckbiobank.org) 
researchers.

## Installation

### Directly from github
The latest version of `ckbplotr` can be installed directly from 
github using devtools.
```{r install from github, eval = FALSE}
install.packages('devtools')
devtools::install_github('neilstats/ckbplotr')
```

### Or from source package
`ckbplotr` can also be installed from its source package. The R packages 
`ggplot2`, `magrittr`, `readr`, `tibble`, `dplyr`, `purrr` and `rlang` must 
first be installed. These are part of the collection of tidyverse packages.
```{r install tidyverse, eval = FALSE}
# The easiest way is to install the whole tidyverse:
install.packages("tidyverse")

# # Or install just these packages:
# install.packages(c("ggplot2", "readr", "dplyr", "purrr"))
```
Then `ckbplotr` can be installed from its source package using the code:
```{r install from source, eval = FALSE}
install.packages("ckbplotr.tar.gz", repos = NULL, type = "source")
```
Or, in RStudio, open the "Tools" menu and select "Install Packages...".
In the "Install from..." box select "Package Archive File", and in the
"Package archive" box browse to the ckbplotr.tar.gz file.

The source package for the latest release version is available [here](https://github.com/neilstats/ckbplotr/releases/latest).




## The plot_like_ckb function

The `plot_like_ckb` function does three things to a ggplot2 plot:

1. applies a CKB theme (i.e. change the overall appearance)
2. extends the plotting area and manually adds axis lines (so that you can have a custom sized gap between the plotting area and the axes)
3. applies a fixed aspect ratio

```{r a-plot, echo = FALSE}
plot <- ggplot(data = mpg, aes(x = displ, y = hwy)) + geom_point(size = 1)
plot_like_ckb(plot = plot, xlims = c(0, 8), ylims = c(10, 50))
```





## The make_shape_plot function

The `make_shape_plot` function creates a plot of estimates and CIs against risk
factor levels using the `ggplot2` package.

```{r make_shape_plot-example-1, echo = FALSE}
library(ggplot2)
library(ckbplotr)

results <- data.frame(
  est = c(1, 1.25, 1.5, 1.75, 1.1, 1.35, 1.75, 2),
  se = c(0.08, 0.02, 0.07, 0.15, 0.05, 0.02, 0.07, 0.1),
  rf = c(20, 28, 35, 50, 18.5, 25, 32, 47),
  n = c(109, 103, 143, 104, 140, 134, 127, 99),
  is_female = c(0, 0, 0, 0, 1, 1, 1, 1)
)

plot <- make_shape_plot(results[results$is_female == 1,],
                        col.x        = "rf",
                        col.estimate = "est",
                        col.stderr   = "se",
                        col.n        = "n",
                        xlims        = c(15,50),
                        ylims        = c(0.5, 3),
                        scalepoints  = TRUE,
                        title        = NULL)
```





## The make_forest_plot function
The `make_forest_plot` function creates a forest plot using the `ggplot2` graphics 
package. The function returns a named list containg:

* plot: the plot
* data: a data frame from which the plot is generated
* code: ggplot2 code to generate the plot

In RStudio the ggplot2 code used to generate the plot will be shown in the 
'Viewer' pane. If modifications are needed to the plot, then this code can be
copied, edited, and run as needed.

```{r example-forest-plot, echo = FALSE, warning = FALSE, fig.width = 8, fig.height = 6}
set.seed(57911624)
exampleresults <- function(){
  data.frame(variable = c('nmr_l_vldl_p', 'nmr_m_vldl_p', 'nmr_s_vldl_p',
                          'nmr_idl_p',
                          'nmr_l_ldl_p', 'nmr_m_ldl_p', 'nmr_s_ldl_p',
                          'nmr_l_vldl_tg', 'nmr_m_vldl_tg', 'nmr_s_vldl_tg',
                          'nmr_idl_tg',
                          'nmr_l_ldl_tg', 'nmr_m_ldl_tg', 'nmr_s_ldl_tg',
                          'nmr_l_vldl_c', 'nmr_m_vldl_c', 'nmr_s_vldl_c',
                          'nmr_idl_c',
                          'nmr_l_ldl_c', 'nmr_m_ldl_c', 'nmr_s_ldl_c'),
             estimate = rnorm(21, 0, 0.02),
             stderr   = 0.012 + abs(rnorm(21, 0, 0.015)),
             n        = round(runif(21, 100, 2000)),
             nb       = round(runif(21, 100, 2000)))
}
resultsA <- exampleresults()
resultsB <- exampleresults()
resultsC <- exampleresults()
resultsD <- exampleresults()
resultsE <- exampleresults()

headings <- data.frame(heading1 = rep(c("Lipoprotein particle concentration",
                                        "Triglycerides concentration",
                                        "Cholesterol concentration"), each = 7),
                       heading2 = rep(c("VLDL", "VLDL", "VLDL",
                                        "IDL",
                                        "LDL", "LDL", "LDL"), times = 3),
                       heading3 = rep(c("Large", "Medium", "Small",
                                        NA,
                                        "Large", "Medium", "Small") , times = 3),
                       variable = c('nmr_l_vldl_p', 'nmr_m_vldl_p', 'nmr_s_vldl_p',
                                    'nmr_idl_p',
                                    'nmr_l_ldl_p', 'nmr_m_ldl_p', 'nmr_s_ldl_p',
                                    'nmr_l_vldl_tg', 'nmr_m_vldl_tg', 'nmr_s_vldl_tg',
                                    'nmr_idl_tg',
                                    'nmr_l_ldl_tg', 'nmr_m_ldl_tg', 'nmr_s_ldl_tg',
                                    'nmr_l_vldl_c', 'nmr_m_vldl_c', 'nmr_s_vldl_c',
                                    'nmr_idl_c',
                                    'nmr_l_ldl_c', 'nmr_m_ldl_c', 'nmr_s_ldl_c'))

forestplot <- make_forest_plot(headings         = headings,
                               rows             = c("Lipoprotein particle concentration",
                                                    "Triglycerides concentration"),
                               cols             = list(resultsA, resultsB),
                               exponentiate     = TRUE,
                               colnames         = c("Analysis A", "Analysis B"),
                               col.key          = "variable",
                               ci.delim         = " - ",
                               xlim             = c(0.9, 1.1),
                               xticks           = c(0.9, 1, 1.1),
                               blankrows        = c(1, 1, 0, 1),
                               scalepoints      = TRUE,
                               pointsize        = 3,
                               col.left         = c("n"),
                               col.left.space   = c(0.02),
                               col.left.heading = c("No. of\nevents"),
                               col.right.space  = 0.02,
                               col.heading.space = 1.5,
                               heading.space    = 2,
                               plot.space       = 8)
```

### Expected warning
You may get the following warning when using this function.

> Vectorized input to `element_text()` is not officially supported.
> Results may be unexpected or may change in future versions of ggplot2.

## make_jasper_forest_plot function
The `make_jasper_forest_plot` function requires the in-house Jasper package, 
which is not publicly available.

